limit_req_zone $binary_remote_addr zone={{ app_server_himation_limit_zone_name }}:10m rate=1r/s;

upstream {{ app_server_himation_upstream_name }} {
  server 127.0.0.1:{{ app_server_himation_varnish_port }};
}

server {
  listen {{ app_server_himation_port }};
  server_name {{ app_server_himation_server_name | require_value }};
  return 301 https://$server_name$request_uri;
}

server {
  listen {{ app_server_himation_port_https }} ssl http2;
  server_name {{ app_server_himation_server_name | require_value }};

  ssl_certificate {{ app_server_ssl_certificate_path }};
  ssl_certificate_key {{ app_server_ssl_certificate_key_path }};

  add_header Strict-Transport-Security "max-age=31536000; includeSubdomains;";

  gzip on;
  gzip_types application/javascript image/svg+xml text/css;
  gzip_vary on;

  autoindex off;
  root {{ himation_public_dir }};
  try_files $uri @{{ app_server_himation_proxy_name }};

  location {{ himation_assets_path | trailing_slash_url }} {
    alias {{ himation_assets_dir | trailing_slash_fs }};

    {% if himation_optimize_assets %}
      add_header Cache-Control "public";
      expires max;
    {% endif %}
  }

  {% for url in himation_rate_limited_urls %}
  location {{ url | trailing_slash_url }} {
    limit_req zone={{ app_server_himation_limit_zone_name }} burst=5;

    {{ lookup("template", "nginx/himation_proxy.conf.j2") }}
  }
  {% endfor %}

  location @{{ app_server_himation_proxy_name }} {
    {{ lookup("template", "nginx/himation_proxy.conf.j2") }}
  }

  client_max_body_size 2M;
}
