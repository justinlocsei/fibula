upstream {{ chiton_server_upstream_name }} {
  server unix://{{ chiton_server_socket_path }};
}

server {
  listen {{ chiton_server_port }};
  server_name {{ chiton_server_name | require_value }};
  return 301 https://$server_name$request_uri;
}

server {
  listen {{ chiton_server_port_https }} ssl http2;
  server_name {{ chiton_server_name | require_value }};

  ssl_certificate {{ app_server_ssl_certificate_path }};
  ssl_certificate_key {{ app_server_ssl_certificate_key_path }};

  add_header Strict-Transport-Security "max-age=31536000; includeSubdomains;";

  gzip on;
  gzip_types application/javascript text/css;
  gzip_vary on;

  autoindex off;
  root {{ chiton_public_files_dir }};
  try_files $uri $uri/ @{{ chiton_server_proxy_name }};

  location {{ chiton_assets_url | trailing_slash_url }} {
    add_header Cache-Control "public";
    alias {{ chiton_assets_dir | trailing_slash_fs }};
    expires max;
  }

  location @{{ chiton_server_proxy_name }} {
    proxy_redirect off;
    proxy_set_header Host $http_host;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto https;

    proxy_pass http://{{ chiton_server_upstream_name }};
  }

  client_max_body_size 10M;
}
