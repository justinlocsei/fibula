---
- name: add all known keys to the application user's authorized keys
  copy:
    dest: "{{ himation_user_ssh_dir.path }}/authorized_keys"
    content: "{{ himation_user_authorized_keys | join('\n') }}"
    mode: 0600

- name: fetch the source code
  git:
    accept_hostkey: yes
    clone: yes
    dest: "{{ himation_source_dir }}"
    repo: git@github.com:justinlocsei/himation.git
    update: yes
    version: "{{ himation_git_branch }}"

- name: install Ruby dependencies
  bundler:
    chdir: "{{ himation_source_dir }}"
    gem_path: "vendor/bundle"
    deployment_mode: no
    state: present

- name: install Node dependencies
  npm:
    path: "{{ himation_source_dir }}"
    production: no
    state: present

- name: link source directories through npm
  command: npm run link
  args:
    chdir: "{{ himation_source_dir }}"

- name: create the configuration file
  template:
    src: settings_development.json.j2
    dest: "{{ himation_source_dir }}/config/settings.json"
    mode: 0644
