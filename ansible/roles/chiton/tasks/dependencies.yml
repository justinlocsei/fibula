---
- name: install all Python dependencies in a virtualenv
  pip:
    requirements: "{{ chiton_requirements_dir }}/{{ item }}"
    executable: "{{ python_pip_executable }}"
    virtualenv: "{{ chiton_virtualenv_dir }}"
    virtualenv_python: "{{ python_executable }}"
    virtualenv_site_packages: no
    state: present
  with_items:
    - core.txt
    - development.txt

- name: create the application database
  postgresql_db:
    name: "{{ chiton_db_name }}"
    login_host: "{{ chiton_db_host | require_value }}"
    login_password: "{{ chiton_db_root_password | require_value }}"
    login_user: "{{ chiton_db_root_name }}"
    port: "{{ chiton_db_port | require_value }}"
    state: present

- name: create the application database user
  postgresql_user:
    name: "{{ chiton_db_user_name }}"
    password: "{{ chiton_db_user_password | require_value }}"
    db: "{{ chiton_db_name }}"
    priv: ALL
    role_attr_flags: LOGIN
    login_host: "{{ chiton_db_host | require_value }}"
    login_password: "{{ chiton_db_root_password | require_value }}"
    login_user: "{{ chiton_db_root_name }}"
    port: "{{ chiton_db_port | require_value }}"
    state: present

- name: run pending database migrations
  shell: "{{ chiton_python_bin | quote }} manage.py migrate"
  args:
    chdir: "{{ chiton_source_dir }}"
  environment:
    CHITON_CONFIG_FILE: "{{ chiton_config_file }}"

- name: create the in-app administrator account
  shell: "{{ chiton_python_bin | quote }} manage.py ensuresuperuser --username {{ chiton_admin_name | quote }} --email {{ chiton_admin_email | quote }} --password {{ chiton_admin_password | quote }}"
  args:
    chdir: "{{ chiton_source_dir }}"
  environment:
    CHITON_CONFIG_FILE: "{{ chiton_config_file }}"
  no_log: yes
