---
- name: add a robots.txt file
  copy:
    src: public/robots.txt
    dest: "{{ chiton_current_version_public_dir }}/robots.txt"
    owner: "{{ chiton_user }}"
    group: "{{ chiton_group }}"
    mode: 0644

- name: update the current version's symlink
  file:
    src: "{{ chiton_current_version_dir }}"
    dest: "{{ chiton_current_dir }}"
    owner: "{{ chiton_user }}"
    group: "{{ chiton_group }}"
    state: link
  notify:
    - reload chiton

- name: determine old releases
  shell: ls -dt {{ chiton_versions_dir | quote }}/* | tail -n +{{ chiton_keep_releases + 1 }}
  register: chiton_old_releases
  changed_when: False

- name: prune old releases
  file:
    path: "{{ item }}"
    state: absent
  with_items: "{{ chiton_old_releases.stdout | newline_list }}"
